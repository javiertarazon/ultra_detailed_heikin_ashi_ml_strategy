# AI Agent Instructions for Bot Trader Copilot

## Architecture Overview
This is a modular trading system with centralized entry via `descarga_datos/main.py`. Key components:
- **Core**: Data providers (CCXT for crypto, MT5 for forex), order executors, live trading orchestrators
- **Strategies**: ML-enhanced strategies like `UltraDetailedHeikinAshiML` using trained models from `models/`
- **Backtesting**: Parallel optimization with Optuna, results in `data/dashboard_results/`
- **Data Flow**: SQLite primary ‚Üí CSV fallback ‚Üí auto-download via `utils/storage.py`
- **Config**: Centralized in `descarga_datos/config/config.yaml` (YAML format)

## Critical Workflows
- **Backtest**: `python descarga_datos/main.py --backtest` (uses config.yaml symbols/timeframes)
- **Optimize**: `python descarga_datos/main.py --optimize` (Optuna trials, saves to models/)
- **Live Trading**: `python descarga_datos/main.py --live` (sandbox mode by default in config)
- **Tests**: `python -m pytest descarga_datos/tests/test_quick_backtest.py` (smoke test)
- **Data Download**: Handled automatically by `ensure_data_availability()` in backtests

## Project Conventions
- **Sandbox First**: Always enable `sandbox: true` in exchange configs for testing
- **ML Models**: Train via optimization, load from `models/` using `ModelManager`
- **Indicators**: Use TALIB via `utils/talib_wrapper.py`, fallback to pandas implementations
- **Risk Management**: ATR-based stops, max drawdown limits from config
- **Logging**: Structured via `utils/logger.py`, metrics in `utils/logger_metrics.py`
- **Dependencies**: Install from root `requirements.txt`, uses virtual env `.venv/`

## Integration Points
- **Exchanges**: CCXT for crypto (Binance/Bybit), MT5 for forex
- **Data Sources**: Yahoo Finance fallback, auto-download for missing data
- **External APIs**: Streamlit dashboard, Plotly for visualization
- **Cross-Component**: Strategies call indicators, risk management applies to all trades

## Examples
- Add new strategy: Extend `strategies/base_strategy.py`, register in config.yaml `strategies:` section
- Modify indicators: Update `indicators/technical_indicators.py`, ensure TALIB compatibility
- Change config: Edit `config/config.yaml`, reload via `config_loader.py`

## AI Response Guidelines
- **Language**: All responses must be in Spanish.
- **Code Modifications**: The strategy (`strategies/ultra_detailed_heikin_ashi_ml_strategy.py`) and main modules (`descarga_datos/main.py`, core modules) are blocked from structural modifications. Only parameter improvements are allowed that enhance functionality and profitability without altering the core structure.

## Data Management Rules
- **Centralized Configuration**: All configuration is centralized in `descarga_datos/config/config.yaml`. Use this for all parameters.
- **Data Verification Flow**: When executing any main function requiring historical data (backtest, optimization, data download, data audit, model training), first verify if data exists in the SQLite database. If present, use those data. If not, proceed to download with corresponding modules, process, verify, calculate necessary indicators, and execute the corresponding main function.
- **Data Priority**: SQLite primary ‚Üí CSV fallback ‚Üí auto-download. Never skip verification steps.

## Directory Structure Policy - STRICT ENFORCEMENT

### **üö® DUPLICATE DIRECTORIES PROHIBITED**
**Critical Policy**: Duplicate directory structures are strictly forbidden and will be immediately corrected.

#### **üìÅ CORRECT STRUCTURE (MANDATORY):**
```
botcopilot-sar/
‚îú‚îÄ‚îÄ descarga_datos/           ‚úÖ ONLY ALLOWED LOCATION
‚îÇ   ‚îú‚îÄ‚îÄ data/                 ‚úÖ CENTRALIZED DATA STORAGE
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ csv/              ‚úÖ CSV files
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard_results/ ‚úÖ Backtest results
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ optimization_pipeline/ ‚úÖ Optimization data
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ optimization_results/ ‚úÖ Strategy optimization
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [other data folders]
‚îÇ   ‚îî‚îÄ‚îÄ [other descarga_datos folders]
‚îî‚îÄ‚îÄ [root level files only]
```

#### **‚ùå FORBIDDEN STRUCTURES (NEVER CREATE):**
```
‚ùå descarga_datos/descarga_datos/data/  ‚Üê DUPLICATE - ELIMINATE IMMEDIATELY
‚ùå data/ (at root level)               ‚Üê DUPLICATE - ELIMINATE IMMEDIATELY  
‚ùå logs/ (at root level)               ‚Üê DUPLICATE - ELIMINATE IMMEDIATELY
‚ùå descarga_datos/data/descarga_datos/ ‚Üê NESTED DUPLICATE - FIX ROUTES
```

### **üîß CORRECTIONS IMPLEMENTED - v4.5**

#### **Fixed Path Issues:**
1. **Configuration Files**: Changed `path: data` ‚Üí `path: descarga_datos/data` in all YAML configs
2. **Default Parameters**: Updated default paths in storage classes and indicators
3. **Optimization Scripts**: Fixed relative paths in `run_optimization_pipeline2.py` and `strategy_optimizer.py`
4. **Environment Files**: Corrected database URLs in `.env` files

#### **Code Corrections Applied:**
```python
# ‚ùå BEFORE (Created duplicates)
results_dir = Path("descarga_datos/data/optimization_pipeline")

# ‚úÖ AFTER (Correct relative paths)  
results_dir = Path(__file__).parent.parent / "data" / "optimization_pipeline"
```

#### **Files Corrected:**
- `descarga_datos/config/config.yaml`
- `descarga_datos/config/*.yaml` (all backups)
- `descarga_datos/utils/storage.py`
- `descarga_datos/utils/market_data_validator.py` 
- `descarga_datos/indicators/technical_indicators.py`
- `descarga_datos/.env.example*`
- `descarga_datos/optimizacion/run_optimization_pipeline2.py`
- `descarga_datos/optimizacion/strategy_optimizer.py`

### **üõ°Ô∏è PREVENTION MEASURES**
- **Path Validation**: All paths must be relative to script location using `Path(__file__).parent.parent`
- **Configuration Audit**: YAML configs must use `descarga_datos/data` prefix
- **Code Review**: Any hardcoded "data/" paths trigger immediate correction
- **Testing**: Directory structure validation in CI/CD pipeline

### **üö® IMMEDIATE ACTION REQUIRED**
If duplicate directories are detected:
1. **STOP ALL OPERATIONS**
2. **Move data** to correct location (`descarga_datos/data/`)
3. **Delete duplicates** 
4. **Fix code paths** causing the duplication
5. **Test thoroughly** before resuming operations

**Violation Severity**: HIGH - Duplicate directories corrupt data integrity and system stability.

## Error Prevention Rules
- **Avoid SQL Metadata Errors**: Ensure correct column count in INSERT statements (e.g., 9 values for 9 columns in data_metadata). Reference `utils/storage.py` fixes.
- **Handle KeyboardInterrupt Gracefully**: Implement try/except/finally blocks for shutdown, always launch dashboard if results exist.
- **Normalize Metrics Consistently**: Win rate must be decimal (0-1), not percentage. Validate in tests.
- **Dashboard Port Fallback**: Check port availability (8519-8523) and use fallback if occupied.
- **Async Shutdown Handling**: Manage `asyncio.CancelledError` and close connections properly.
- **Avoid Synthetic Data**: Never use or generate synthetic data; all operations must use real downloaded or live data.

## Critical Error Prevention - v4.0 Lessons Learned

### **üö® JSON Serialization Errors - PREVENIR SIEMPRE**
**Problema v3.5**: Objetos `datetime` no serializables causaban errores recurrentes al guardar historial de posiciones.
**Lecci√≥n**: NUNCA guardar objetos datetime directamente en estructuras que ser√°n serializadas a JSON.
**Regla de Oro**:
```
‚úÖ SIEMPRE usar convert_to_json_serializable() antes de json.dump()
‚úÖ Convertir datetime.now() a datetime.now().isoformat() inmediatamente
‚úÖ Validar tipos antes de serializaci√≥n
‚úÖ Implementar try/catch en todas las operaciones de guardado
```

**C√≥digo Problem√°tico (NUNCA REPETIR)**:
```python
# ‚ùå MAL - Caus√≥ errores cada 5 minutos
position['open_time'] = datetime.now()  # Objeto datetime
json.dump(position_history, file)       # ERROR: not JSON serializable

# ‚úÖ BIEN - Implementado en v4.0
position['open_time'] = datetime.now().isoformat()  # String
serializable_data = [convert_to_json_serializable(pos) for pos in position_history]
json.dump(serializable_data, file)
```

### **üö® Missing Method Errors - IMPLEMENTAR INTERFACES COMPLETAS**
**Problema v3.5**: M√©todo `calculate_position_risk` faltante causaba errores cada 60 segundos.
**Lecci√≥n**: NUNCA dejar m√©todos abstractos o interfaces sin implementar.
**Regla de Oro**:
```
‚úÖ Verificar TODOS los m√©todos requeridos antes de commits
‚úÖ Implementar interfaces 100% completas
‚úÖ Usar @abstractmethod para forzar implementaci√≥n
‚úÖ Validar llamadas existentes antes de cambios
```

**Prevenci√≥n**:
```python
# ‚úÖ REQUERIDO - Verificaci√≥n antes de commits
def validate_implementation(self):
    required_methods = ['calculate_position_risk', 'validate_position', 'update_stops']
    for method in required_methods:
        if not hasattr(self, method):
            raise NotImplementedError(f"M√©todo requerido faltante: {method}")
```

### **üö® Resource Leak Errors - SHUTDOWN GRACEFUL OBLIGATORIO**
**Problema v3.5**: Conexiones no cerradas causaban memory leaks y warnings.
**Lecci√≥n**: NUNCA omitir manejo de recursos en shutdown.
**Regla de Oro**:
```
‚úÖ try/except/finally en TODOS los shutdown
‚úÖ await close() en conexiones async
‚úÖ Manejar asyncio.CancelledError expl√≠citamente
‚úÖ Liberar recursos en finally block
```

**Patr√≥n Correcto**:
```python
async def shutdown(self):
    try:
        # Operaciones de cierre
        await self.connection.close()
    except asyncio.CancelledError:
        pass  # Graceful cancellation
    except Exception as e:
        self.logger.error(f"Shutdown error: {e}")
    finally:
        # ‚úÖ SIEMPRE ejecutar - liberaci√≥n de recursos
        self.resources = None
        self.logger.info("Shutdown completo")
```

### **üö® Data Type Errors - VALIDACI√ìN ESTRICTA**
**Problema v3.5**: Tipos inconsistentes causaban operaciones err√≥neas.
**Lecci√≥n**: NUNCA asumir tipos de datos sin validaci√≥n.
**Regla de Oro**:
```
‚úÖ Validar tipos antes de operaciones num√©ricas
‚úÖ Normalizar None a valores por defecto
‚úÖ Usar type hints estrictos
‚úÖ Implementar validaci√≥n de entrada en m√©todos p√∫blicos
```

**Validaci√≥n Requerida**:
```python
def validate_numeric_input(self, value: Any, default: float = 0.0) -> float:
    """Valida entrada num√©rica, retorna default si inv√°lido."""
    try:
        result = float(value) if value is not None else default
        return result if not (math.isnan(result) or math.isinf(result)) else default
    except (TypeError, ValueError):
        return default
```

### **üö® Live Trading Stability - VALIDACI√ìN OBLIGATORIA**
**Problema v3.5**: Sistema funcional pero con errores recurrentes.
**Lecci√≥n**: NUNCA desplegar sin validaci√≥n completa de estabilidad.
**Regla de Oro**:
```
‚úÖ 24h testing m√≠nimo antes de producci√≥n
‚úÖ Validar sin errores JSON en logs
‚úÖ Verificar shutdown graceful
‚úÖ Confirmar integridad de datos
‚úÖ Monitoreo de recursos sin leaks
```

## Data Integrity Rules
- **Real Data Only**: All metrics, results, and strategy executions must derive from real downloaded or live data. No artificial alterations, improvements, or synthetic enhancements.
- **Result Authenticity**: Metrics and results must be the direct outcome of strategy execution on real data, without manipulation or optimization beyond parameter tuning.

Reference: `descarga_datos/ARCHIVOS MD/README.md` for sandbox testing details.